<!DOCTYPE html>
<!--http://www.kirupa.com/html5/create_an_analog_clock_using_the_canvas.htm-->
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Smartclock MISA</title>
    <style>
        .body {
            background-color: black;
            overflow:hidden;
        }
        #clock {
            border: 0 solid #000000;
        }
    </style>
</head>
<body class="body">
<canvas id="clock" height="1280px" width="700px">
    If you can see this message, your browser does not support canvas
    and needs an upate. Sorry. :(
</canvas>
<script>
    (function () {

        //TODO mettre l'init dans un constructeur
        var canvas = document.getElementById("clock");
        var context = canvas.getContext("2d");

        // Rayon de l'horloge
        var clockRadius = canvas.width / 2;

        // Center clock in the canvas
        var centerX = canvas.width / 2;
        var centerY = canvas.height / 2;

        document.addEventListener('DOMContentLoaded', startTimer);

        var hourMarkersImg = new Image();
        hourMarkersImg.src = 'images/Cadran.png';

        var font = "Calibri";

        //TODO Export weather into other module

        //Weather
        var weatherUrl = 'https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%20in%20%28select%20woeid%20from%20geo.places%281%29%20where%20text%3D%22lyon%22%29&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys';
        var weatherHttpRequest = new XMLHttpRequest();
        weatherHttpRequest.onreadystatechange = parseWeatherResponse;
        weatherHttpRequest.open('GET', weatherUrl);
        weatherHttpRequest.send();

        var weatherIcon = new Image();
        var weatherInfos = {};

        var weatherLabels = [
            "simple_weather_icon_03.png", //"tornado",
            "simple_weather_icon_03.png", //"tropical storm",
            "simple_weather_icon_03.png", //"hurricane",
            "simple_weather_icon_03.png", //"severe thunderstorms",
            "simple_weather_icon_03.png", //"thunderstorms",
            "simple_weather_icon_03.png", //"mixed rain and snow",
            "simple_weather_icon_03.png", //"mixed rain and sleet",
            "simple_weather_icon_03.png", //"mixed snow and sleet",
            "simple_weather_icon_03.png", //"freezing drizzle",
            "simple_weather_icon_03.png", //"drizzle",
            "simple_weather_icon_03.png", //"freezing rain",
            "simple_weather_icon_03.png", //"showers",
            "simple_weather_icon_03.png", //"showers",
            "simple_weather_icon_03.png", //"snow flurries",
            "simple_weather_icon_03.png", //"light snow showers",
            "simple_weather_icon_03.png", //"blowing snow",
            "simple_weather_icon_03.png", //"snow",
            "simple_weather_icon_03.png", //"hail",
            "simple_weather_icon_03.png", //"sleet",
            "simple_weather_icon_03.png", //"dust",
            "simple_weather_icon_03.png", //"foggy",
            "simple_weather_icon_03.png", //"haze",
            "simple_weather_icon_03.png", //"smoky",
            "simple_weather_icon_03.png", //"blustery",
            "simple_weather_icon_03.png", //"windy",
            "simple_weather_icon_03.png", //"cold",
            "simple_weather_icon_04.png", //"cloudy",
            "simple_weather_icon_04.png", //"mostly cloudy (night)",
            "simple_weather_icon_04.png", //"mostly cloudy (day)",
            "simple_weather_icon_07.png", //"partly cloudy (night)",
            "simple_weather_icon_03.png", //"partly cloudy (day)",
            "simple_weather_icon_02.png", //"clear (night)",
            "simple_weather_icon_01.png", //"sunny",
            "simple_weather_icon_01.png", //"fair (night)",
            "simple_weather_icon_01.png", //"fair (day)",
            "simple_weather_icon_21.png", //"mixed rain and hail",
            "simple_weather_icon_01.png", //"hot",
            "simple_weather_icon_17.png", //"isolated thunderstorms",
            "simple_weather_icon_01.png", //"scattered thunderstorms",
            "simple_weather_icon_01.png", //"scattered thunderstorms",
            "simple_weather_icon_01.png", //"scattered showers",
            "simple_weather_icon_01.png", //"heavy snow",
            "simple_weather_icon_01.png", //"scattered snow showers",
            "simple_weather_icon_01.png", //"heavy snow",
            "simple_weather_icon_06.png", //"partly cloudy",
            "simple_weather_icon_01.png", //"thundershowers",
            "simple_weather_icon_01.png", //"snow showers",
            "simple_weather_icon_01.png", //"isolated thundershowers",
            "simple_weather_icon_01.png"]; //"not available"

        function parseWeatherResponse() {
            if (weatherHttpRequest.readyState === 4) {
                if (weatherHttpRequest.status === 200) {
                    var weatherResponse = JSON.parse(weatherHttpRequest.responseText);
                    var todayForecast = weatherResponse.query.results.channel.item.forecast[0];
                    weatherInfos.tempMin = Math.round((todayForecast.low - 32) * 5 / 9);
                    weatherInfos.tempMax = Math.round((todayForecast.high - 32) * 5 / 9);
                    weatherInfos.weatherMessage = weatherLabels[todayForecast.code];

                    weatherIcon.src = 'images/weather/' + weatherLabels[todayForecast.code];

                } else {
                    //TODO handle cnx errors
//                    alert('There was a problem with the request.');
                }
            }
        }

        function startTimer() {
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            resetCanvas();
            drawOriginCircle();
            drawHourMarkers();
            drawAnalogTime();
            drawNumericTime();
            drawWeather();
        }

        function drawWeather() {
            if (weatherInfos.weatherMessage != "") {
                var dateHeightPosition = 3.5;
                context.drawImage(weatherIcon,
                        centerX - (weatherIcon.width - 20) / 2 ,
                        centerY + clockRadius / dateHeightPosition,
                        weatherIcon.width-20, weatherIcon.height-20);

                context.font = "40pt " + font;
                dateHeightPosition = 1.2;
                var formatedTemperature = weatherInfos.tempMin + "° - " + weatherInfos.tempMax + "°";
                context.fillText(formatedTemperature,
                        centerX,
                        centerY + clockRadius / dateHeightPosition);
            }
        }

        function resetCanvas() {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        function drawOriginCircle() {
            context.beginPath();
            context.arc(centerX, centerY, 7, 0, 2 * Math.PI);
            context.fillStyle = "white";
            context.fill();
        }

        /**
         * Dessine les repères pour les heures dans le fond
         */
        function drawHourMarkers() {
            context.drawImage(hourMarkersImg, 0, 0, canvas.width, canvas.height);
        }

        function drawAnalogTime() {
            var now = new Date();

            var secProgress = now.getSeconds() / 60;
            var minProgress = now.getMinutes() / 60 + (1 / 60) * secProgress;
            var hourProgress = (now.getHours() % 12) / 12 + (1 / 12) * minProgress;

            drawArm({
                progress: hourProgress,
                thickness: 6,
                length: 0.45,
                color: '#FFFFFF'
            });
            drawArm({
                progress: minProgress,
                thickness: 4,
                length: 0.60,
                color: '#FFFFFF'
            });
            drawArm({
                progress: secProgress,
                thickness: 2,
                length: 0.72,
                color: '#FF0000'
            });
        }

        function drawArm(params) {
            const shiftFromCenter = 15;
            context.lineWidth = params.thickness;
            context.strokeStyle = params.color;
            drawLine(params.progress, shiftFromCenter / clockRadius, params.length);
        }

        /**
         * @param progress pourcentage de progression ex: 3h = 15min = 0.25; 6h = 30 min = 0.5
         * @param beginPercent début de la ligne en % du rayon
         * @param endPercent fin de la ligne en % du rayon
         */
        function drawLine(progress, beginPercent, endPercent) {
            // Must define TAU
            Math.TAU = 2 * Math.PI;
            var armRadians = (Math.TAU * (progress)) - (Math.TAU / 4);
            var startingPointX = centerX + Math.cos(armRadians) * (beginPercent * clockRadius);
            var startingPointY = centerY + Math.sin(armRadians) * (beginPercent * clockRadius);
            var endingPointX = centerX + Math.cos(armRadians) * (endPercent * clockRadius);
            var endingPointY = centerY + Math.sin(armRadians) * (endPercent * clockRadius);

            context.beginPath();
            context.moveTo(startingPointX, startingPointY);
            context.lineTo(endingPointX, endingPointY);
            context.stroke();
        }

        function drawNumericTime() {
            var now = new Date();
            context.strokeStyle = "#FFFFFF";
            context.textAlign = 'center';

            context.font = "80pt " + font;
            var daysOfWeek = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
            var dayOfWeekHeightPosition = 1.2;
            context.fillText(daysOfWeek[now.getDay()],
                    centerX,
                    centerY - clockRadius / dayOfWeekHeightPosition);

            context.font = "65pt " + font;
            var dateDay = padZero(now.getDate()) + "/" + padZero(now.getMonth()+1);
            var dateHeightPosition = 1.6;
            context.fillText(dateDay,
                    centerX,
                    centerY - clockRadius / dateHeightPosition);
        }

        function padZero(num) {
            var paddedString = String(num);
            if (num < 10) {
                paddedString = "0" + String(num);
            }
            return paddedString;
        }

    })();
</script>

</body>
</html>
